# アーキテクチャ設計

## 概要
オニオンアーキテクチャを採用。全ての処理はクラスベースで実装する。

## 層構成

```
┌─────────────────────────────────────────┐
│              Handler層                   │
│   リクエスト受付・レスポンス返却          │
└─────────────────┬───────────────────────┘
                  │ 呼び出し
                  ▼
┌─────────────────────────────────────────┐
│              UseCase層                   │
│   ビジネスロジック・ユースケース定義      │
└─────────────────┬───────────────────────┘
                  │ 呼び出し
                  ▼
┌─────────────────────────────────────────┐
│              Infra層                     │
│   外部API連携・技術的責務                │
└─────────────────────────────────────────┘

        ↓ 全層から参照可能 ↓
┌─────────────────────────────────────────┐
│        Config / Constants               │
│   設定値・メッセージ定数                 │
└─────────────────────────────────────────┘
```

## 各層の責務

### Handler層 (`src/handler/`)
- リクエストの受け取り
- レスポンスの返却
- UseCaseの呼び出し
- `lineWebhookHandler`: Strategyパターンでイベントタイプに応じたUseCaseを呼び出す

### UseCase層 (`src/usecase/`)
- ユースケース（ビジネスロジック）を定義
- Infra層のクラスを呼び出して処理を実行
- 1ユースケース = 1クラス

### Infra層 (`src/infra/`)
- 外部APIとの通信
- 技術的な責務を担当
- UseCaseからのみ呼び出される

| ディレクトリ    | 責務                                                    |
| --------------- | ------------------------------------------------------- |
| `infra/google/` | Google系API（Calendar, Speech-to-Text, Gemini, OAuth2） |
| `infra/line/`   | LINE Messaging API                                      |

### Config / Constants
- `config/`: アプリケーション設定（APIエンドポイント、モデル設定など）
- `constants/`: ユーザー向けメッセージ定数

## エントリーポイント

### main.ts
GASのglobal関数を定義。`index.ts`の関数をglobalに公開する。

```typescript
// main.ts
global.doPost = doPost;
global.doGet = doGet;
global.authCallback = authCallback;
```

### index.ts
GASの予約済み関数（doPost, doGet）を実装し、Handlerクラスを呼び出す。

## 依存関係のルール

```
Handler → UseCase → Infra
   ↓         ↓        ↓
   └─────────┴────────┴─→ Config / Constants
```

- **Handler**: UseCaseのみ呼び出し可能
- **UseCase**: Infraのみ呼び出し可能
- **Infra**: 他の層を呼び出さない（外部APIのみ）
- **Config/Constants**: 全層から参照可能

## クラス設計方針

### 命名規則
- Handler: `XxxHandler`
- UseCase: `XxxUseCase`
- Infra: 機能に応じた名前（`OAuth2Manager`, `GeminiApi`, `LineMessagingApi` など）

### DI（依存性注入）
UseCaseはコンストラクタでInfraのインスタンスを受け取る。

```typescript
// 例: CreateEventFromVoiceUseCase
export class CreateEventFromVoiceUseCase {
  public constructor(
    private readonly lineMessaging: LineMessaging,
    private readonly speechToText: SpeechToText,
    private readonly geminiEventExtractor: GeminiEventExtractor,
    private readonly userCalendar: UserCalendar,
    private readonly flexMessageFactory: FlexMessageFactory,
    private readonly oauth2ClientId: string,
    private readonly oauth2ClientSecret: string
  ) { }

  public execute(replyToken: string, messageId: string, userId: string): void {
    // 1. LINE APIから音声を取得
    const audioBlob = this.lineMessaging.fetchAudioContent(messageId);
    
    // 2. Speech-to-Textで音声をテキストに変換
    const transcribedText = this.speechToText.convertSpeechToText(audioBlob);
    
    // 3. Gemini APIでイベント情報を抽出
    const calendarEventData = this.geminiEventExtractor.extractCalendarEventFromText(transcribedText);
    
    // 4. ユーザーのGoogleカレンダーにイベントを作成
    const result = this.userCalendar.createEvent(calendarEventData);
    // ...
  }
}
```

### クラス実装例（Infra層）

```typescript
// 例: LineMessaging
export class LineMessaging {
  constructor(private readonly channelAccessToken: string) {}

  public fetchAudioContent(messageId: string): GoogleAppsScript.Base.Blob | null {
    // LINE APIから音声コンテンツを取得
  }

  public sendTextReply(replyToken: string, messageText: string): void {
    // LINEにテキストメッセージを返信
  }

  public sendFlexReply(replyToken: string, flexContent: any): void {
    // LINEにFlexメッセージを返信
  }
}
```

## 実装状況

- ✅ クラスベース実装完了
- ✅ DI（依存性注入）導入済み: UseCaseはコンストラクタでInfraのインスタンスを受け取る設計
- ✅ オニオンアーキテクチャに基づく層分離完了

## 今後の拡張方針

1. **インターフェース定義**: Infra層のインターフェースを定義し、テスタビリティ向上
2. **Domain層追加**: 必要に応じてドメインオブジェクトを導入（現状は永続化不要のため省略）
3. **Repository層**: データ永続化が必要になった場合、Repository層を追加
