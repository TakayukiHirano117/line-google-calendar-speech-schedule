var global = this;
function doPost() {}

function doGet() {}
(()=>{var E=t=>PropertiesService.getScriptProperties().getProperty(t),T=()=>E("CHANNEL_ACCESS_TOKEN"),C=()=>E("GCP_PROJECT_ID"),f=()=>E("GEMINI_API_KEY"),A=()=>{let t=E("SERVICE_ACCOUNT_KEY");return JSON.parse(t)};var r={LINE_API:{REPLY_ENDPOINT:"https://api.line.me/v2/bot/message/reply",CONTENT_ENDPOINT:"https://api-data.line.me/v2/bot/message"},SPEECH_TO_TEXT:{LOCATION:"global",MODEL:"latest_long",LANGUAGE_CODE:"ja-JP"},GEMINI:{MODEL:"gemini-2.5-flash-lite",ENDPOINT:"https://generativelanguage.googleapis.com/v1beta/models",TEMPERATURE:.3,MAX_OUTPUT_TOKENS:1024},CALENDAR:{DEFAULT_EVENT_DURATION_HOURS:1},COMMANDS:{TODAY:["\u4ECA\u65E5\u306E\u4E88\u5B9A"],WEEK:["\u4ECA\u9031\u306E\u4E88\u5B9A"],HELP:["\u30D8\u30EB\u30D7"]},COLORS:{PRIMARY:"#06C755",SECONDARY:"#AAAAAA",BACKGROUND:"#FFFFFF",ACCENT:"#5B82DB",TEXT_PRIMARY:"#111111",TEXT_SECONDARY:"#666666",BORDER:"#EEEEEE",SUCCESS:"#06C755",WARNING:"#FFCC00"}};var h=t=>{let e=T(),o=`${r.LINE_API.CONTENT_ENDPOINT}/${t}/content`,n={method:"get",headers:{Authorization:`Bearer ${e}`},muteHttpExceptions:!0};try{return UrlFetchApp.fetch(o,n).getBlob()}catch(a){return g("LINE\u97F3\u58F0\u30B3\u30F3\u30C6\u30F3\u30C4\u53D6\u5F97",a),null}},d=(t,e)=>{let o=T();S(o,{replyToken:t,messages:[{type:"text",text:e}]})},u=(t,e)=>{let o=T(),n={replyToken:t,messages:[{type:"flex",altText:e.altText,contents:e.contents}]};S(o,n)},S=(t,e)=>{let n={method:"post",headers:{"Content-Type":"application/json; charset=UTF-8",Authorization:`Bearer ${t}`},payload:JSON.stringify(e),muteHttpExceptions:!0},a=UrlFetchApp.fetch(r.LINE_API.REPLY_ENDPOINT,n);a.getResponseCode()!==200&&g("LINE\u8FD4\u4FE1",a.getContentText())};var p={REQUEST_AUDIO:`\u97F3\u58F0\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u9001\u4FE1\u3057\u3066\u304F\u3060\u3055\u3044

\u307E\u305F\u306F\u4EE5\u4E0B\u306E\u30B3\u30DE\u30F3\u30C9\u3092\u30C6\u30AD\u30B9\u30C8\u3067\u9001\u4FE1\uFF1A
\u30FB\u300C\u4ECA\u65E5\u306E\u4E88\u5B9A\u300D
\u30FB\u300C\u4ECA\u9031\u306E\u4E88\u5B9A\u300D`,AUDIO_FETCH_FAILED:"\u97F3\u58F0\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F",SPEECH_RECOGNITION_FAILED:"\u97F3\u58F0\u306E\u8A8D\u8B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F",CALENDAR_CREATION_FAILED:"\u30AB\u30EC\u30F3\u30C0\u30FC\u3078\u306E\u8FFD\u52A0\u306B\u5931\u6557\u3057\u307E\u3057\u305F",EVENT_EXTRACTION_FAILED:t=>`\u300C${t}\u300D

\u30A4\u30D9\u30F3\u30C8\u60C5\u5831\u3092\u62BD\u51FA\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002\u65E5\u4ED8\u3001\u6642\u523B\u3001\u5185\u5BB9\u3092\u542B\u3081\u3066\u8A71\u3057\u3066\u304F\u3060\u3055\u3044\u3002`,NO_EVENTS_TODAY:"\u4ECA\u65E5\u306E\u4E88\u5B9A\u306F\u3042\u308A\u307E\u305B\u3093",NO_EVENTS_WEEK:"\u4ECA\u9031\u306E\u4E88\u5B9A\u306F\u3042\u308A\u307E\u305B\u3093",HELP:{TITLE:"Voice Calendar\u306E\u4F7F\u3044\u65B9",SECTIONS:[{title:"\u4E88\u5B9A\u3092\u767B\u9332\u3059\u308B",icon:"\u{1F3A4}",items:["\u97F3\u58F0\u30E1\u30C3\u30BB\u30FC\u30B8\u3067\u4E88\u5B9A\u3092\u8A71\u3057\u3066\u304F\u3060\u3055\u3044","\u3010\u57FA\u672C\u7684\u306A\u4F7F\u3044\u65B9\u3011","\u4F8B\uFF1A\u300C\u660E\u65E5\u306E10\u6642\u304B\u3089\u4F1A\u8B70\u300D","\u4F8B\uFF1A\u300C\u6765\u9031\u6708\u66DC14\u6642\u304B\u30892\u6642\u9593\u6253\u3061\u5408\u308F\u305B\u300D","\u4F8B\uFF1A\u300C1\u670825\u65E5\u306E15\u6642\u304B\u3089\u6B6F\u533B\u8005\u300D","\u3010\u65E5\u4ED8\u306E\u6307\u5B9A\u3011","\u30FB\u6307\u5B9A\u306A\u3057 \u2192 \u4ECA\u65E5\u306E\u4E88\u5B9A\u3068\u3057\u3066\u767B\u9332","\u30FB\u300C\u660E\u65E5\u300D\u300C\u6765\u9031\u6708\u66DC\u300D\u306A\u3069\u76F8\u5BFE\u7684\u306A\u8868\u73FE\u3082OK","\u30FB\u300C1\u670825\u65E5\u300D\u306E\u3088\u3046\u306A\u5177\u4F53\u7684\u306A\u65E5\u4ED8\u3082OK","\u3010\u6642\u523B\u306E\u6307\u5B9A\u3011","\u30FB\u6307\u5B9A\u306A\u3057 \u2192 \u73FE\u5728\u6642\u523B\u309215\u5206\u5358\u4F4D\u3067\u5207\u308A\u4E0A\u3052","\u3000(\u4F8B: 9:03\u21929:15\u30019:47\u219210:00)","\u30FB\u958B\u59CB\u6642\u523B\u306E\u307F\u6307\u5B9A \u2192 1\u6642\u9593\u306E\u4E88\u5B9A\u3068\u3057\u3066\u767B\u9332","\u30FB\u300C2\u6642\u9593\u300D\u306A\u3069\u6642\u9593\u3092\u6307\u5B9A \u2192 \u305D\u306E\u9577\u3055\u3067\u767B\u9332","\u30FB\u300C14\u6642\u307E\u3067\u300D\u306A\u3069\u7D42\u4E86\u6642\u523B\u3092\u6307\u5B9A \u2192 \u305D\u306E\u6642\u523B\u307E\u3067"]},{title:"\u4E88\u5B9A\u3092\u78BA\u8A8D\u3059\u308B",icon:"\u{1F4C5}",items:["\u300C\u4ECA\u65E5\u306E\u4E88\u5B9A\u300D\u2192 \u4ECA\u65E5\u306E\u4E88\u5B9A\u4E00\u89A7","\u300C\u4ECA\u9031\u306E\u4E88\u5B9A\u300D\u2192 \u76F4\u8FD17\u65E5\u9593\u306E\u4E88\u5B9A"]},{title:"\u305D\u306E\u4ED6",icon:"\u{1F4A1}",items:["\u300C\u30D8\u30EB\u30D7\u300D\u2192 \u3053\u306E\u4F7F\u3044\u65B9\u3092\u8868\u793A"]}]}};var R=()=>{let t=A(),e=W(t);return Q(e)},W=t=>{let e=j(),o=V(t.client_email),n=Utilities.base64EncodeWebSafe(JSON.stringify(e)),a=Utilities.base64EncodeWebSafe(JSON.stringify(o)),s=`${n}.${a}`,i=Utilities.computeRsaSha256Signature(s,t.private_key),l=Utilities.base64EncodeWebSafe(i);return`${s}.${l}`},j=()=>({alg:"RS256",typ:"JWT"}),V=t=>{let e=Math.floor(Date.now()/1e3),o=e+3600;return{iss:t,scope:"https://www.googleapis.com/auth/cloud-platform",aud:"https://oauth2.googleapis.com/token",exp:o,iat:e}},Q=t=>{let e="https://oauth2.googleapis.com/token",o={method:"post",payload:{grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:t}},n=UrlFetchApp.fetch(e,o);return JSON.parse(n.getContentText()).access_token};var F=t=>{let e=C(),o=R(),n=Utilities.base64Encode(t.getBytes()),s=`https://speech.googleapis.com/v2/${Z(e)}:recognize`,i=tt(n),l=ot(o,i);try{let c=UrlFetchApp.fetch(s,l),x=JSON.parse(c.getContentText());return m("Speech-to-Text v2 \u30B9\u30C6\u30FC\u30BF\u30B9",c.getResponseCode()),m("Speech-to-Text v2 \u7D50\u679C",JSON.stringify(x)),et(x)}catch(c){return g("Speech-to-Text v2",c),null}},Z=t=>`projects/${t}/locations/${r.SPEECH_TO_TEXT.LOCATION}/recognizers/_`,tt=t=>({config:{autoDecodingConfig:{},languageCodes:[r.SPEECH_TO_TEXT.LANGUAGE_CODE],model:r.SPEECH_TO_TEXT.MODEL},content:t}),et=t=>{if(!t.results||t.results.length===0)return null;let e=t.results[0].alternatives;return!e||e.length===0?null:e[0].transcript},ot=(t,e)=>({method:"post",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},payload:JSON.stringify(e),muteHttpExceptions:!0});var D=t=>{let e=f(),o=nt(t),n=at(o),a=it(e),s={method:"post",headers:{"Content-Type":"application/json"},payload:JSON.stringify(n),muteHttpExceptions:!0};try{let i=UrlFetchApp.fetch(a,s),l=JSON.parse(i.getContentText());return m("Gemini \u30B9\u30C6\u30FC\u30BF\u30B9",i.getResponseCode()),m("Gemini \u7D50\u679C",JSON.stringify(l)),ct(l)}catch(i){return g("Gemini API",i),null}},nt=t=>{let e=rt(),o=st();return`\u4EE5\u4E0B\u306E\u97F3\u58F0\u8A8D\u8B58\u30C6\u30AD\u30B9\u30C8\u304B\u3089\u30AB\u30EC\u30F3\u30C0\u30FC\u30A4\u30D9\u30F3\u30C8\u60C5\u5831\u3092\u62BD\u51FA\u3057\u3066\u304F\u3060\u3055\u3044\u3002
\u4ECA\u65E5\u306E\u65E5\u4ED8\u306F${e}\u3001\u73FE\u5728\u6642\u523B\u306F${o}\u3067\u3059\u3002

\u97F3\u58F0\u8A8D\u8B58\u30C6\u30AD\u30B9\u30C8: "${t}"

\u4EE5\u4E0B\u306EJSON\u5F62\u5F0F\u3067\u51FA\u529B\u3057\u3066\u304F\u3060\u3055\u3044\uFF1A
{
  "title": "\u30A4\u30D9\u30F3\u30C8\u306E\u30BF\u30A4\u30C8\u30EB\uFF08\u7C21\u6F54\u306B\u3001\u7D75\u6587\u5B57\u30921\u3064\u542B\u3081\u3066\u9B45\u529B\u7684\u306B\uFF09",
  "startTime": "YYYY-MM-DDTHH:MM:00+09:00",
  "endTime": "YYYY-MM-DDTHH:MM:00+09:00",
  "description": "\u8A73\u7D30\u8AAC\u660E\uFF08\u5143\u306E\u30C6\u30AD\u30B9\u30C8\u3092\u542B\u3081\u3066\u88DC\u8DB3\u60C5\u5831\u3082\uFF09"
}

\u30EB\u30FC\u30EB\uFF1A
- \u958B\u59CB\u6642\u523B\u304C\u6307\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306F\u3001\u73FE\u5728\u6642\u523B\u309215\u5206\u5358\u4F4D\u3067\u5207\u308A\u4E0A\u3052\u305F\u6642\u523B\u306B\u3059\u308B\uFF08\u4F8B: 9:03\u21929:15\u30019:47\u219210:00\u30019:00\u21929:00\uFF09
- \u7D42\u4E86\u6642\u523B\u306E\u6C7A\u5B9A\u65B9\u6CD5\uFF1A
  - \u300C2\u6642\u9593\u300D\u300C30\u5206\u300D\u306A\u3069\u6240\u8981\u6642\u9593\u304C\u6307\u5B9A\u3055\u308C\u305F\u5834\u5408\u306F\u3001\u958B\u59CB\u6642\u523B\u306B\u305D\u306E\u6642\u9593\u3092\u52A0\u7B97\u3059\u308B
  - \u300C14\u6642\u307E\u3067\u300D\u306A\u3069\u7D42\u4E86\u6642\u523B\u304C\u660E\u793A\u3055\u308C\u305F\u5834\u5408\u306F\u3001\u305D\u306E\u6642\u523B\u3092\u4F7F\u7528\u3059\u308B
  - \u3069\u3061\u3089\u3082\u6307\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306F\u3001\u958B\u59CB\u6642\u523B\u306E1\u6642\u9593\u5F8C\u306B\u3059\u308B
- \u300C\u660E\u65E5\u300D\u300C\u6765\u9031\u300D\u306A\u3069\u306E\u76F8\u5BFE\u7684\u306A\u65E5\u4ED8\u8868\u73FE\u3092\u6B63\u78BA\u306B\u5909\u63DB\u3059\u308B
- \u30BF\u30A4\u30C8\u30EB\u306F30\u6587\u5B57\u4EE5\u5185\u3067\u3001\u5185\u5BB9\u3092\u7AEF\u7684\u306B\u8868\u73FE\u3059\u308B
- description\u306B\u306F\u5143\u306E\u97F3\u58F0\u5185\u5BB9\u3092\u3082\u3068\u306B\u8981\u7D04\u3092\u66F8\u3044\u3066\u4E0B\u3055\u3044\u3002
- \u30A4\u30D9\u30F3\u30C8\u60C5\u5831\u304C\u542B\u307E\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306Fnull\u3092\u8FD4\u3059
- \u30BF\u30A4\u30C8\u30EB\u3084\u8AAC\u660E\u6587\u306B\u7D75\u6587\u5B57\u306F\u4F7F\u7528\u3057\u306A\u3044

JSON\u5F62\u5F0F\u306E\u307F\u3092\u8FD4\u3057\u3001\u4ED6\u306E\u8AAC\u660E\u306F\u4E00\u5207\u4E0D\u8981\u3067\u3059\u3002`},rt=()=>{let t=new Date,o=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"][t.getDay()];return`${t.getFullYear()}\u5E74${t.getMonth()+1}\u6708${t.getDate()}\u65E5(${o}\u66DC\u65E5)`},st=()=>{let t=new Date,e=t.getHours(),o=t.getMinutes();return`${e}\u6642${o}\u5206`},at=t=>({contents:[{parts:[{text:t}]}],generationConfig:{temperature:r.GEMINI.TEMPERATURE,maxOutputTokens:r.GEMINI.MAX_OUTPUT_TOKENS}}),it=t=>`${r.GEMINI.ENDPOINT}/${r.GEMINI.MODEL}:generateContent?key=${t}`,ct=t=>{try{let e=t?.candidates?.[0]?.content?.parts?.[0]?.text;if(!e)return null;let o=lt(e);m("\u62BD\u51FA\u3055\u308C\u305FJSON",o);let n=JSON.parse(o);return pt(n)?n:null}catch(e){return g("Gemini \u30EC\u30B9\u30DD\u30F3\u30B9\u89E3\u6790",e),null}},lt=t=>{let e=t.replace(/```json/g,"").replace(/```/g,"").trim(),o=e.indexOf("{"),n=e.lastIndexOf("}");return o===-1||n===-1?e:e.substring(o,n+1)},pt=t=>t&&typeof t.title=="string"&&t.title.length>0;var b=t=>{try{let e=CalendarApp.getDefaultCalendar(),o=new Date(t.startTime),n=new Date(t.endTime),a={description:t.description||""},i=e.createEvent(t.title,o,n,a).getId();return m("\u30AB\u30EC\u30F3\u30C0\u30FC\u30A4\u30D9\u30F3\u30C8\u4F5C\u6210\u6210\u529F",t.title),m("\u30A4\u30D9\u30F3\u30C8ID",i),i}catch(e){return g("\u30AB\u30EC\u30F3\u30C0\u30FC\u30A4\u30D9\u30F3\u30C8\u4F5C\u6210",e),null}},I=t=>{let e=t.replace("@google.com","");return`https://www.google.com/calendar/event?eid=${gt(e)}`},gt=t=>{let e=CalendarApp.getDefaultCalendar().getId(),o=`${t} ${e}`;return Utilities.base64Encode(o).replace(/=+$/,"")},_=()=>{let t=CalendarApp.getDefaultCalendar(),e=new Date,o=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0),n=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59);return t.getEvents(o,n).map(s=>({title:s.getTitle(),startTime:s.getStartTime(),endTime:s.getEndTime(),isAllDay:s.isAllDayEvent()}))},L=()=>{let t=CalendarApp.getDefaultCalendar(),e=new Date,o=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+7,23,59,59),a=t.getEvents(o,n),s={};for(let i=0;i<7;i++){let l=new Date(e.getFullYear(),e.getMonth(),e.getDate()+i),c=N(l);s[c]={date:l,events:[]}}return a.forEach(i=>{let l=i.getStartTime(),c=N(l);s[c]&&s[c].events.push({title:i.getTitle(),startTime:i.getStartTime(),endTime:i.getEndTime(),isAllDay:i.isAllDayEvent()})}),s},N=t=>`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`;var M=(t,e)=>{let o=new Date(t.startTime),n=new Date(t.endTime),a=ut(o),s=`${O(o)} \u301C ${O(n)}`;return{altText:`\u2705 \u30A4\u30D9\u30F3\u30C8\u3092\u4F5C\u6210\u3057\u307E\u3057\u305F: ${t.title}`,contents:{type:"bubble",size:"kilo",header:{type:"box",layout:"horizontal",contents:[{type:"text",text:"\u2705",size:"lg",flex:0},{type:"text",text:"\u30A4\u30D9\u30F3\u30C8\u3092\u4F5C\u6210\u3057\u307E\u3057\u305F",size:"md",weight:"bold",color:r.COLORS.TEXT_PRIMARY,margin:"sm",flex:1}],backgroundColor:"#F0FFF0",paddingAll:"lg"},body:{type:"box",layout:"vertical",contents:[{type:"text",text:t.title,size:"lg",weight:"bold",color:r.COLORS.TEXT_PRIMARY,wrap:!0},{type:"separator",margin:"lg"},{type:"box",layout:"horizontal",contents:[{type:"text",text:"\u{1F4C5}",size:"sm",flex:0},{type:"text",text:a,size:"sm",color:r.COLORS.TEXT_SECONDARY,margin:"sm",flex:1}],margin:"lg"},{type:"box",layout:"horizontal",contents:[{type:"text",text:"\u{1F552}",size:"sm",flex:0},{type:"text",text:s,size:"sm",color:r.COLORS.TEXT_SECONDARY,margin:"sm",flex:1}],margin:"sm"}],paddingAll:"lg"},footer:{type:"box",layout:"vertical",contents:[{type:"button",action:{type:"uri",label:"\u30AB\u30EC\u30F3\u30C0\u30FC\u3067\u898B\u308B",uri:e},style:"primary",color:r.COLORS.PRIMARY}],paddingAll:"lg"}}}},v=t=>{let e=new Date,o=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"],n=`${e.getMonth()+1}/${e.getDate()}\uFF08${o[e.getDay()]}\uFF09`;if(t.length===0)return w("\u4ECA\u65E5\u306E\u4E88\u5B9A",n,p.NO_EVENTS_TODAY);t.sort((s,i)=>s.startTime-i.startTime);let a=t.map(s=>mt(s));return{altText:`\u{1F4C5} \u4ECA\u65E5\u306E\u4E88\u5B9A\uFF08${t.length}\u4EF6\uFF09`,contents:{type:"bubble",size:"mega",header:{type:"box",layout:"horizontal",contents:[{type:"text",text:"\u{1F4C5}",size:"xl",flex:0},{type:"box",layout:"vertical",contents:[{type:"text",text:"\u4ECA\u65E5\u306E\u4E88\u5B9A",size:"lg",weight:"bold",color:"#FFFFFF"},{type:"text",text:n,size:"sm",color:"#FFFFFFBB"}],margin:"md",flex:1}],backgroundColor:r.COLORS.PRIMARY,paddingAll:"lg"},body:{type:"box",layout:"vertical",contents:a,paddingAll:"lg",spacing:"md"},footer:{type:"box",layout:"vertical",contents:[{type:"text",text:`${t.length}\u4EF6\u306E\u4E88\u5B9A`,size:"sm",color:r.COLORS.TEXT_SECONDARY,align:"center"}],paddingAll:"md"}}}},mt=t=>({type:"box",layout:"horizontal",contents:[{type:"text",text:t.isAllDay?"\u7D42\u65E5":O(t.startTime),size:"sm",color:r.COLORS.ACCENT,weight:"bold",flex:0},{type:"text",text:t.title,size:"sm",color:r.COLORS.TEXT_PRIMARY,wrap:!0,margin:"lg",flex:1}],paddingAll:"sm",backgroundColor:"#F8F8F8",cornerRadius:"md"}),P=t=>{let e=Object.keys(t),o=0;if(e.forEach(a=>{o+=t[a].events.length}),o===0)return w("\u4ECA\u9031\u306E\u4E88\u5B9A","\u76F4\u8FD17\u65E5\u9593",p.NO_EVENTS_WEEK);let n=e.map(a=>{let s=t[a],i=s.date,l=s.events,c=xt(i,new Date);return dt(i,l,c)});return{altText:`\u{1F4C5} \u4ECA\u9031\u306E\u4E88\u5B9A\uFF08${o}\u4EF6\uFF09`,contents:{type:"bubble",size:"mega",header:{type:"box",layout:"horizontal",contents:[{type:"text",text:"\u{1F4C5}",size:"xl",flex:0},{type:"box",layout:"vertical",contents:[{type:"text",text:"\u4ECA\u9031\u306E\u4E88\u5B9A",size:"lg",weight:"bold",color:"#FFFFFF"},{type:"text",text:"\u76F4\u8FD17\u65E5\u9593",size:"sm",color:"#FFFFFFBB"}],margin:"md",flex:1}],backgroundColor:r.COLORS.ACCENT,paddingAll:"lg"},body:{type:"box",layout:"vertical",contents:n,paddingAll:"lg",spacing:"sm"},footer:{type:"box",layout:"vertical",contents:[{type:"text",text:`\u5408\u8A08 ${o}\u4EF6\u306E\u4E88\u5B9A`,size:"sm",color:r.COLORS.TEXT_SECONDARY,align:"center"}],paddingAll:"md"}}}},dt=(t,e,o)=>{let n=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"],a=t.getMonth()+1,s=t.getDate(),i=n[t.getDay()],l=`${a}/${s}\uFF08${i}\uFF09`,c=e.length,x=c===0?"\u2212":`${c}\u4EF6`,X=c===0?"\u4E88\u5B9A\u306A\u3057":e.slice(0,2).map(y=>y.title).join(", ").substring(0,20)+(e.slice(0,2).map(y=>y.title).join(", ").length>20||c>2?"...":""),q=o?"#E8F5E9":"#F8F8F8",K=o?r.COLORS.PRIMARY:r.COLORS.TEXT_PRIMARY;return{type:"box",layout:"horizontal",contents:[{type:"text",text:l,size:"sm",weight:"bold",color:K,flex:0},{type:"text",text:x,size:"sm",color:c===0?r.COLORS.SECONDARY:r.COLORS.ACCENT,weight:c===0?"regular":"bold",margin:"lg",flex:0},{type:"text",text:X,size:"xs",color:r.COLORS.TEXT_SECONDARY,wrap:!1,margin:"md",flex:1}],paddingAll:"md",backgroundColor:q,cornerRadius:"md"}},w=(t,e,o)=>({altText:o,contents:{type:"bubble",size:"kilo",body:{type:"box",layout:"vertical",contents:[{type:"text",text:"\u{1F4C5}",size:"3xl",align:"center"},{type:"text",text:t,size:"lg",weight:"bold",align:"center",margin:"lg",color:r.COLORS.TEXT_PRIMARY},{type:"text",text:e,size:"sm",align:"center",color:r.COLORS.TEXT_SECONDARY},{type:"separator",margin:"xl"},{type:"text",text:o,size:"md",align:"center",margin:"xl",color:r.COLORS.TEXT_SECONDARY}],paddingAll:"xl"}}}),$=()=>{let t=p.HELP,e=t.SECTIONS.flatMap((o,n)=>({type:"box",layout:"vertical",contents:[{type:"box",layout:"horizontal",contents:[{type:"text",text:o.icon,size:"md",flex:0},{type:"text",text:o.title,size:"md",weight:"bold",color:r.COLORS.TEXT_PRIMARY,margin:"sm",flex:1}]},{type:"box",layout:"vertical",contents:o.items.map(s=>({type:"text",text:s,size:"sm",color:r.COLORS.TEXT_SECONDARY,wrap:!0,margin:"sm"})),margin:"sm",paddingStart:"lg"}],margin:n===0?"none":"xl"}));return{altText:"Voical\u306E\u4F7F\u3044\u65B9",contents:{type:"bubble",size:"mega",header:{type:"box",layout:"horizontal",contents:[{type:"text",text:"\u2753",size:"xl",flex:0},{type:"text",text:t.TITLE,size:"lg",weight:"bold",color:"#FFFFFF",margin:"md",flex:1}],backgroundColor:"#7B7B7B",paddingAll:"lg"},body:{type:"box",layout:"vertical",contents:e,paddingAll:"lg"}}}},ut=t=>{let e=["\u65E5","\u6708","\u706B","\u6C34","\u6728","\u91D1","\u571F"],o=t.getMonth()+1,n=t.getDate(),a=e[t.getDay()];return`${o}\u6708${n}\u65E5\uFF08${a}\uFF09`},O=t=>{let e=t.getHours(),o=t.getMinutes().toString().padStart(2,"0");return`${e}:${o}`},xt=(t,e)=>t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate();var z=(t,e)=>{let o=h(e);if(!o){d(t,p.AUDIO_FETCH_FAILED);return}let n=F(o);if(!n){d(t,p.SPEECH_RECOGNITION_FAILED);return}let a=D(n);if(!a){d(t,p.EVENT_EXTRACTION_FAILED(n));return}let s=b(a);if(s){let i=I(s),l=M(a,i);u(t,l)}else d(t,p.CALENDAR_CREATION_FAILED)};var G=t=>{let e=$();u(t,e)};var U=t=>{let e=L(),o=P(e);u(t,o)};var Y=t=>{let e=_(),o=v(e);u(t,o)};var k=t=>{let e=t.replyToken;Tt(t)?z(e,t.message.id):yt(t)?Et(e,t.message.text):d(e,p.REQUEST_AUDIO)},Et=(t,e)=>{let o=e.trim();ft(o)?G(t):Ct(o)?U(t):Ot(o)?Y(t):d(t,p.REQUEST_AUDIO)},Tt=t=>t.type==="message"&&t.message.type==="audio",yt=t=>t.type==="message"&&t.message.type==="text",Ot=t=>r.COMMANDS.TODAY.some(e=>t.includes(e)),Ct=t=>r.COMMANDS.WEEK.some(e=>t.includes(e)),ft=t=>r.COMMANDS.HELP.some(e=>t.includes(e)),m=(t,e)=>{console.log(`${t}: ${e}`)},g=(t,e)=>{console.log(`${t}\u30A8\u30E9\u30FC: ${e}`)};function B(t){let e=JSON.parse(t.postData.contents);if(!At(e))return H({status:"no events"});let o=e.events[0];return k(o),H({status:"ok"})}function J(t){return CalendarApp.getDefaultCalendar(),PropertiesService.getScriptProperties(),UrlFetchApp.fetch("https://www.google.com",{muteHttpExceptions:!0}),Utilities.base64Encode("test"),ContentService.createTextOutput("\u2705 \u5168\u30B5\u30FC\u30D3\u30B9\u306E\u8A8D\u8A3C\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002\u3053\u306E\u30DA\u30FC\u30B8\u306F\u9589\u3058\u3066OK\u3067\u3059\u3002").setMimeType(ContentService.MimeType.TEXT)}var At=t=>t.events&&t.events.length>0,H=t=>ContentService.createTextOutput(JSON.stringify(t)).setMimeType(ContentService.MimeType.JSON);global.doPost=B;global.doGet=J;})();
